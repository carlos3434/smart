var tabla='datatable_tabletools';
var users;
/* BASIC ;*/
var responsiveHelper_datatable_tabletools = undefined;

var breakpointDefinition = {
    tablet : 1024,
    phone : 480
};
var columnDefs=[
    {
        "targets": 0,
        "data": "id",
        "name": "id",
        "searchable":false
    },
    {
        "targets": 1,
        "data": "nombres",
        "name": "nombres"
    },
    {
        "targets": 2,
        "data": "apellidos",
        "name": "apellidos"
    },
    {
        "targets": 3,
        "data": "numero_telefono",
        "name": "numero_telefono",
        "searchable":false
    },
    {
        "targets": 4,
        "data": "genero",
        "name": "genero",
        "searchable":false
    },
    {
        "targets": 5,
        "name": "verified",
        "searchable":false,
        "data": function ( row, type, val, meta ) {
            //console.log(meta);
            return '<td><a class="btn btn-primary btn-sm" data-toggle="modal" data-target="#userModal" data-id="'+meta.row+'" data-titulo="Editar"><i class="fa fa-edit fa-lg"></i> </a></td>';
        },
        "defaultContent": '',
    },
    {
        "targets": 6,
        "name": "deleted_at",
        "searchable":false,
        "data": function ( row, type, val, meta ) {
            estado='<span id="'+row.id+'" onClick="activar('+row.id+')" class="btn btn-danger">Inactivo</span>';
            if (row.deleted_at===null){
                estado='<span id="'+row.id+'" onClick="desactivar('+row.id+')" class="btn btn-success">Activo</span>';
            }
            return estado;
        },
        "defaultContent": '',
    }
];

var dataTable={
    "processing": true,
    "serverSide": true,
    "stateSave": true,
    "searching": true,
    "ordering": true,
    "stateLoadCallback": function (settings) {
        $("body").append('<div class="overlay"></div><div class="loading-img"></div>');
    },
    "stateSaveCallback": function (settings) { // Cuando finaliza el ajax
        $(".overlay,.loading-img").remove();
    },
    "ajax": {
        "url": "user/all-paginate",
        "type": "POST",
        "data": function(d){
            d.per_page=d.length;
            d.page=(d.start+d.length)/d.length;
            d.filter=d.search.value;
        },
    },
    columnDefs,
    "sDom": "<'dt-toolbar'<'col-xs-12 col-sm-6'f><'col-sm-6 col-xs-6 hidden-xs'T>r>"+
            "t"+
            "<'dt-toolbar-footer'<'col-sm-6 col-xs-12 hidden-xs'i><'col-sm-6 col-xs-12'p>>",
    "oLanguage": {
        "sSearch": '<span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>'
    },
    "oTableTools": {
        "aButtons": [
            "copy",
            "csv",
            "xls",
            {
                "sExtends": "pdf",
                "sTitle": "SmartAdmin_PDF",
                "sPdfMessage": "SmartAdmin PDF Export",
                "sPdfSize": "letter"
            },
            {
                "sExtends": "print",
                "sMessage": "Generated by SmartAdmin <i>(press Esc to close)</i>"
            }
        ],
        "sSwfPath": "js/plugin/datatables/swf/copy_csv_xls_pdf.swf"
    },
    "autoWidth" : true,
    "preDrawCallback" : function() {
        // Initialize the responsive datatables helper once.
        if (!responsiveHelper_datatable_tabletools) {
            responsiveHelper_datatable_tabletools = new ResponsiveDatatablesHelper($('#'+tabla), breakpointDefinition);
        }
    },
    "rowCallback" : function(nRow,data) {
        responsiveHelper_datatable_tabletools.createExpandIcon(nRow);
    },
    "drawCallback" : function(oSettings) {
        users = oSettings.aoData;
        responsiveHelper_datatable_tabletools.respond();
    }
};
$(document).ready(function() {
    pageSetUp();
    $('#userModal').on('show.bs.modal', function (event) {
        /*
        $('#txt_fecha_nacimiento').daterangepicker({
            format: 'YYYY-MM-DD',
            singleDatePicker: true,
            showDropdowns: true
        });*/

        var button = $(event.relatedTarget); // captura al boton
        var titulo = button.data('titulo'); // extrae del atributo data-
        var id = button.data('id'); //extrae el id del atributo data

        var user = users[id]._aData;
        // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
        // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
        var modal = $(this); //captura el modal
        modal.find('.modal-title').text(titulo+' Persona');
        //$('#form_personas_modal [data-toggle="tooltip"]').css("display","none");
        //$("#form_personas_modal input[type='hidden']").remove();
        //slctGlobal.listarSlct('cargo','slct_cargos','simple');
        
        if(titulo=='Nuevo'){
            
            modal.find('.modal-footer .btn-primary').text('Guardar');
            modal.find('.modal-footer .btn-primary').attr('onClick','Agregar();');
            //$('#form_personas_modal #txt_nombre').focus();
            //var datos={estado:1};
            //slctGlobal.listarSlct('area','slct_area','simple',null,datos);
            //slctGlobal.listarSlct('rol','slct_rol','simple',null,datos);
        }
        else{


            //Persona.CargarAreas(PersonasG.id); //no es multiselect
            modal.find('.modal-footer .btn-primary').text('Actualizar');
            modal.find('.modal-footer .btn-primary').attr('onClick','Editar();');
            //PersonasG
            //$('#form_personas_modal #txt_paterno').val( PersonasG.paterno );
            //$('#form_personas_modal #txt_materno').val( PersonasG.materno );
            //$('#form_personas_modal #txt_nombre').val( PersonasG.nombre );
            //$('#form_personas_modal #txt_dni').val( PersonasG.dni );
            //$('#form_personas_modal #slct_sexo').val( PersonasG.sexo );
            //$('#form_personas_modal #txt_email').val( PersonasG.email );
            //$('#form_personas_modal #txt_fecha_nacimiento').val( PersonasG.fecha_nacimiento );
            //$('#form_personas_modal #txt_password').val( '' );
            

            //$('#form_personas_modal #slct_estado').val( PersonasG.estado );
            //$("#form_personas_modal").append("<input type='hidden' value='"+PersonasG.id+"' name='id'>");

            //var datos={estado:1};
            //var idsarea=[]; idsarea.push(PersonasG.area_id);
            //var idsrol=[]; idsrol.push(PersonasG.rol_id);
            //slctGlobal.listarSlct('area','slct_area','simple',idsarea,datos);
            
            //slctGlobal.listarSlctFijo('area','slct_area',PersonasG.area);
         //   alert(PersonasG.fecha_nacimiento_id);
            //slctGlobal.listarSlct('rol','slct_rol','simple',idsrol,datos);
            
            //slctGlobal.listarSlctFijo('rol','slct_rol',PersonasG.rol);
        }
        /*
        $( "#form_personas_modal #slct_estado" ).trigger('change');
        $( "#form_personas_modal #slct_estado" ).change(function() {
            if ($( "#form_personas_modal #slct_estado" ).val()==1) {
                $('#f_areas_cargo').removeAttr('disabled');
            }
            else {
                $('#f_areas_cargo').attr('disabled', 'disabled');
            }
        });*/
    });

    $('#userModal').on('hide.bs.modal', function (event) {
        var modal = $(this); //captura el modal
        modal.find('.modal-body input').val(''); // busca un input para copiarle texto
        //$('#slct_cargos,#slct_rol,#slct_area').multiselect('destroy');
        //$("#t_cargoPersona").html('');
    });

    $('#'+tabla).dataTable(dataTable);
});


desactivar=function(id){

    $('#'+tabla).DataTable().ajax.reload();
};
activar=function(id){

    $('#'+tabla).DataTable().ajax.reload();
};