var tabla='datatable_tabletools';
var user;
var users;
/* BASIC ;*/
var responsiveHelper_datatable_tabletools = undefined;

var breakpointDefinition = {
    tablet : 1024,
    phone : 480
};
jQuery.each( [ "put", "delete" ], function( i, method ) {
  jQuery[ method ] = function( url, data, callback, type ) {
    if ( jQuery.isFunction( data ) ) {
      type = type || callback;
      callback = data;
      data = undefined;
    }

    return jQuery.ajax({
      url: url,
      type: method,
      dataType: type,
      data: data,
      success: callback
    });
  };
});
var columnDefs=[
    {
        "targets": 0,
        "data": "id",
        "name": "id",
        "searchable":false
    },
    {
        "targets": 1,
        "data": "nombres",
        "name": "nombres"
    },
    {
        "targets": 2,
        "data": "apellidos",
        "name": "apellidos"
    },
    {
        "targets": 3,
        "data": "numero_telefono",
        "name": "numero_telefono",
        "searchable":false
    },
    {
        "targets": 4,
        "data": "genero",
        "name": "genero",
        "searchable":false
    },
    {
        "targets": 5,
        "name": "verified",
        "searchable":false,
        "data": function ( row, type, val, meta ) {
            return '<td><a class="btn btn-primary btn-sm" data-toggle="modal" data-target="#userModal" data-id="'+row.id+'" data-titulo="Editar"><i class="fa fa-edit fa-lg"></i> </a></td>';
        },
        "defaultContent": '',
    },
    {
        "targets": 6,
        "name": "deleted_at",
        "searchable":false,
        "data": function ( row, type, val, meta ) {
            estado='<span id="'+row.id+'" onClick="activar('+row.id+')" class="btn btn-danger">Inactivo</span>';
            if (row.deleted_at===null){
                estado='<span id="'+row.id+'" onClick="desactivar('+row.id+')" class="btn btn-success">Activo</span>';
            }
            return estado;
        },
        "defaultContent": '',
    }
];

var dataTable={
    "processing": true,
    "serverSide": true,
    "stateSave": true,
    "searching": true,
    "ordering": true,
    "stateLoadCallback": function (settings) {
        $("body").append('<div class="overlay"></div><div class="loading-img"></div>');
    },
    "stateSaveCallback": function (settings) { // Cuando finaliza el ajax
        $(".overlay,.loading-img").remove();
    },
    "ajax": {
        "url": "user",
        "type": "GET",
        "data": function(d){
            d.per_page=d.length;
            d.page=(d.start+d.length)/d.length;
            d.filter=d.search.value;
        },
    },
    columnDefs,
    "sDom": "<'dt-toolbar'<'col-xs-12 col-sm-6'f><'col-sm-6 col-xs-6 hidden-xs'T>r>"+
            "t"+
            "<'dt-toolbar-footer'<'col-sm-6 col-xs-12 hidden-xs'i><'col-sm-6 col-xs-12'p>>",
    "oLanguage": {
        "sSearch": '<span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>'
    },
    "oTableTools": {
        "aButtons": [
            "copy",
            "csv",
            "xls",
            {
                "sExtends": "pdf",
                "sTitle": "SmartAdmin_PDF",
                "sPdfMessage": "SmartAdmin PDF Export",
                "sPdfSize": "letter"
            },
            {
                "sExtends": "print",
                "sMessage": "Generated by SmartAdmin <i>(press Esc to close)</i>"
            }
        ],
        "sSwfPath": "js/plugin/datatables/swf/copy_csv_xls_pdf.swf"
    },
    "autoWidth" : true,
    "preDrawCallback" : function() {
        // Initialize the responsive datatables helper once.
        if (!responsiveHelper_datatable_tabletools) {
            responsiveHelper_datatable_tabletools = new ResponsiveDatatablesHelper($('#'+tabla), breakpointDefinition);
        }
    },
    "rowCallback" : function(nRow,data) {
        responsiveHelper_datatable_tabletools.createExpandIcon(nRow);
    },
    "drawCallback" : function(oSettings) {
        //users = oSettings.aoData;
        responsiveHelper_datatable_tabletools.respond();
    }
};
$(document).ready(function() {
    pageSetUp();

    $('#userModal').on('show.bs.modal', function (event) {
        /*
        $('#txt_fecha_nacimiento').daterangepicker({
            format: 'YYYY-MM-DD',
            singleDatePicker: true,
            showDropdowns: true
        });
*/
        var button = $(event.relatedTarget); // captura al boton
        var titulo = button.data('titulo'); // extrae del atributo data-
        

        
        // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
        // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
        var modal = $(this); //captura el modal
        modal.find('.modal-title').text(titulo+' Usuario');
        $('#form_user [data-toggle="tooltip"]').css("display","none");
        $("#form_user input[type='hidden']").remove();
        //slctGlobal.listarSlct('cargo','slct_cargos','simple');
        
        if(titulo=='Nuevo'){
            
            modal.find('.modal-footer .btn-primary').text('Guardar');
            modal.find('.modal-footer .btn-primary').attr('onClick','Agregar();');
            $('#form_user #txt_nombre').focus();
        } else {
            var id = button.data('id'); //extrae el id del atributo data
            //var user = users[id]._aData;
            user = Users.get(id);
            //Persona.CargarAreas(PersonasG.id); //no es multiselect
            modal.find('.modal-footer .btn-primary').text('Actualizar');
            modal.find('.modal-footer .btn-primary').attr('onClick','updateUser();');

        }
    });

    $('#userModal').on('hide.bs.modal', function (event) {
        var modal = $(this); //captura el modal
        modal.find('.modal-body input').val(''); // busca un input para copiarle texto
        //$('#slct_cargos,#slct_rol,#slct_area').multiselect('destroy');
        //$("#t_cargoPersona").html('');
    });

    $('#'+tabla).dataTable(dataTable);
});
updateUser=function(){
    Users.update();
};
usuarioEdit=function(){
    $('#form_user #txt_nombres').val( user.nombres );
    $('#form_user #txt_apellidos').val( user.apellidos );
    $('#form_user #txt_dni').val( user.dni );
    $('#form_user #txt_direccion').val( user.direccion );
    $('#form_user #txt_numero_telefono').val( user.numero_telefono );
    $('#form_user #txt_fecha_nacimiento').val( user.fecha_nacimiento );
    $('#form_user #txt_password').val( user.password );
    $('#form_user #txt_email').val( user.email );
    $('#form_user #slct_genero').val( user.genero );
    $('#form_user #txt_username').val( user.username );
    var estado = 0;
    if (user.deleted_at===null) {
        estado = 1;
    }
    $('#form_user #slct_estado').val( estado );
};
desactivar=function(id){

    $('#'+tabla).DataTable().ajax.reload();
};
activar=function(id){

    $('#'+tabla).DataTable().ajax.reload();
};